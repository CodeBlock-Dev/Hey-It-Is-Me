@using HeyItIsMe.Application.Services.Pages

<div class="wizard-step">
    <div class="text-center mb-4">
        <i class="bi bi-camera text-primary" style="font-size: 2.5rem;"></i>
        <h3 class="mt-3 mb-3">Upload Your Avatar</h3>
        <p class="text-muted">Your avatar will be displayed on your page and used to generate personalized facts</p>
    </div>
    
    <div class="form-group mb-4">
        <label class="form-label fw-bold">Profile Picture</label>
        <InputFile OnChange="@OnAvatarFileSelected" accept="image/*" class="form-control" />
        @if (AvatarPreview != null)
        {
            <div class="mt-3">
                <img src="@AvatarPreview" alt="Avatar preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />
            </div>
        }
        <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            <strong>Important:</strong> Please upload a clear profile picture showing only your face (not your full body). This will be displayed on your page and used by AI to generate personalized facts. A well-lit, front-facing photo where your face is clearly visible works best.
        </div>
    </div>
    
    <div class="d-flex justify-content-end">
        <button class="btn btn-primary" @onclick="HandleUpdateAvatar" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            else
            {
                <i class="bi bi-check-lg me-2"></i>
            }
            Continue
        </button>
    </div>
</div>

<ImageCropper ShowCropper="@ShowCropper" 
              ImageDataUrl="@SelectedImageDataUrl" 
              OnCropComplete="HandleCropComplete" 
              OnCancel="HandleCropCancel" />


@code {
    [Parameter] public string PageId { get; set; }
    [Parameter] public EventCallback OnNext { get; set; }
    
    private string AvatarBase64;
    private string AvatarPreview;
    private bool IsLoading = false;
    private bool ShowCropper = false;
    private string SelectedImageDataUrl;
    private string SelectedImageContentType;
    
    private async Task OnAvatarFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            // Validate file size (max 10MB)
            if (file.Size > 10 * 1024 * 1024)
            {
                return;
            }

            // Validate file type
            if (!file.ContentType.StartsWith("image/"))
            {
                return;
            }

            // Convert to base64 for cropper
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var imageBytes = memoryStream.ToArray();
            var base64 = Convert.ToBase64String(imageBytes);
            
            // Store image data for cropper
            SelectedImageDataUrl = $"data:{file.ContentType};base64,{base64}";
            SelectedImageContentType = file.ContentType;
            ShowCropper = true;
            
            StateHasChanged();
        }
    }
    
    private async Task HandleCropComplete(string croppedBase64)
    {
        AvatarBase64 = croppedBase64;
        AvatarPreview = $"data:{SelectedImageContentType};base64,{croppedBase64}";
        ShowCropper = false;
        SelectedImageDataUrl = null;
        StateHasChanged();
    }
    
    private async Task HandleCropCancel()
    {
        ShowCropper = false;
        SelectedImageDataUrl = null;
        StateHasChanged();
    }
    
    private async Task HandleUpdateAvatar()
    {
        if (AvatarBase64 == null || string.IsNullOrWhiteSpace(PageId))
            return;
            
        IsLoading = true;
        var result = await PageService.UpdatePageAvatarImage(PageId, AvatarBase64);
        if (result.IsSuccess)
        {
            // Update page state to next step in wizard
            var stateResult = await PageService.UpdatePageState(PageId, Core.Domain.Pages.PageState.PendingReferenceImage);
            if (!stateResult.IsSuccess)
            {
                stateResult.ShowErrorToast(ToastService);
            }
            else
            {
                await OnNext.InvokeAsync();
            }
        }
        else
        {
            result.ShowErrorToast(ToastService);
        }
        IsLoading = false;
    }
}
